{% comment %}
  ORÉA AI Assistant Section
  Floating chat widget for customer inquiries
{% endcomment %}

{% if section.settings.enable_assistant %}
<div class="fixed bottom-8 right-8 z-[100]" id="ai-assistant-container">
  <button 
    id="ai-assistant-trigger"
    class="bg-white hover:bg-stone-50 text-black px-6 py-4 rounded-full shadow-[0_10px_30px_-5px_rgba(0,0,0,0.1)] flex items-center space-x-4 transition-all transform hover:-translate-y-1 active:scale-95 border border-stone-100 group"
    aria-label="Open inquiry chat"
  >
    <span class="text-[10px] font-bold uppercase tracking-[0.2em]">{{ section.settings.trigger_text }}</span>
    <div class="w-px h-4 bg-stone-200"></div>
    <svg class="w-5 h-5 text-stone-400 group-hover:text-black transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
    </svg>
  </button>

  <div id="ai-assistant-panel" class="hidden bg-white w-[380px] h-[550px] shadow-[0_20px_60px_-15px_rgba(0,0,0,0.15)] rounded-lg flex-col border border-stone-100 overflow-hidden">
    <!-- Header -->
    <div class="bg-stone-50 p-6 flex justify-between items-center border-b border-stone-100">
      <div class="space-y-1">
        <p class="text-[10px] font-bold text-black tracking-[0.2em] uppercase">{{ section.settings.panel_title }}</p>
        <p class="text-[9px] text-stone-400">{{ section.settings.panel_subtitle }}</p>
      </div>
      <button id="ai-assistant-close" class="text-stone-300 hover:text-black transition-colors" aria-label="Close chat">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Messages Container -->
    <div id="ai-messages" class="flex-grow p-6 overflow-y-auto space-y-6 bg-white">
      <!-- Welcome message -->
      <div class="flex items-start space-x-3">
        <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-stone-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 2L4.5 9L12 22L19.5 9L12 2Z" stroke-width="1" />
          </svg>
        </div>
        <div class="bg-stone-50 rounded-lg p-4 max-w-[85%]">
          <p class="text-[13px] text-stone-600 font-light leading-relaxed">
            {{ section.settings.welcome_message }}
          </p>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-6 bg-white border-t border-stone-100">
      <div class="relative flex items-center">
        <input 
          type="text" 
          id="ai-input"
          placeholder="{{ section.settings.input_placeholder }}"
          class="w-full pr-12 pl-0 py-3 bg-transparent border-b border-stone-200 text-sm focus:outline-none focus:border-black transition-all placeholder:text-stone-300"
        />
        <button 
          id="ai-send"
          class="absolute right-0 p-2 text-black disabled:text-stone-200 transition-colors"
          aria-label="Send message"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
        </button>
      </div>
      <p class="text-[9px] text-stone-300 mt-3 text-center uppercase tracking-widest font-bold">
        {{ section.settings.input_note }}
      </p>
    </div>
  </div>
</div>

<script>
(function() {
  const trigger = document.getElementById('ai-assistant-trigger');
  const panel = document.getElementById('ai-assistant-panel');
  const closeBtn = document.getElementById('ai-assistant-close');
  const input = document.getElementById('ai-input');
  const sendBtn = document.getElementById('ai-send');
  const messagesContainer = document.getElementById('ai-messages');

  function openPanel() {
    panel.classList.remove('hidden');
    panel.classList.add('flex');
    trigger.classList.add('hidden');
    input.focus();
  }

  function closePanel() {
    panel.classList.add('hidden');
    panel.classList.remove('flex');
    trigger.classList.remove('hidden');
  }

  function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex items-start space-x-3 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    messageDiv.innerHTML = isUser ? `
      <div class="w-8 h-8 rounded-full bg-black flex items-center justify-center flex-shrink-0">
        <span class="text-white text-[10px] font-bold">YOU</span>
      </div>
      <div class="bg-black text-white rounded-lg p-4 max-w-[85%]">
        <p class="text-[13px] font-light leading-relaxed">${content}</p>
      </div>
    ` : `
      <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center flex-shrink-0">
        <svg class="w-4 h-4 text-stone-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 2L4.5 9L12 22L19.5 9L12 2Z" stroke-width="1" />
        </svg>
      </div>
      <div class="bg-stone-50 rounded-lg p-4 max-w-[85%]">
        <p class="text-[13px] text-stone-600 font-light leading-relaxed">${content}</p>
      </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function showTyping() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'flex items-start space-x-3';
    typingDiv.innerHTML = `
      <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center flex-shrink-0">
        <svg class="w-4 h-4 text-stone-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 2L4.5 9L12 22L19.5 9L12 2Z" stroke-width="1" />
        </svg>
      </div>
      <div class="bg-stone-50 rounded-lg p-4">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-stone-300 rounded-full animate-pulse"></div>
          <div class="w-2 h-2 bg-stone-300 rounded-full animate-pulse" style="animation-delay: 75ms"></div>
          <div class="w-2 h-2 bg-stone-300 rounded-full animate-pulse" style="animation-delay: 150ms"></div>
        </div>
      </div>
    `;
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function hideTyping() {
    const typingDiv = document.getElementById('typing-indicator');
    if (typingDiv) typingDiv.remove();
  }

  async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;

    addMessage(message, true);
    input.value = '';
    sendBtn.disabled = true;

    showTyping();

    // Simulate response (replace with actual API call)
    setTimeout(() => {
      hideTyping();
      addMessage("Thank you for your inquiry. Our team will be in touch shortly. In the meantime, feel free to explore our collections or schedule a consultation.");
      sendBtn.disabled = false;
    }, 1500);
  }

  trigger?.addEventListener('click', openPanel);
  closeBtn?.addEventListener('click', closePanel);
  sendBtn?.addEventListener('click', sendMessage);
  input?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // Listen for custom events to open with pre-filled message
  window.addEventListener('orea-open-concierge', (e) => {
    openPanel();
    if (e.detail?.message) {
      input.value = e.detail.message;
    }
  });

  // Close on ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !panel.classList.contains('hidden')) {
      closePanel();
    }
  });
})();
</script>
{% endif %}

{% schema %}
{
  "name": "AI Assistant",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_assistant",
      "label": "Enable AI Assistant",
      "default": true
    },
    {
      "type": "text",
      "id": "trigger_text",
      "label": "Trigger Button Text",
      "default": "Inquiry"
    },
    {
      "type": "text",
      "id": "panel_title",
      "label": "Panel Title",
      "default": "Contact Us"
    },
    {
      "type": "text",
      "id": "panel_subtitle",
      "label": "Panel Subtitle",
      "default": "We typically respond within 24 hours"
    },
    {
      "type": "textarea",
      "id": "welcome_message",
      "label": "Welcome Message",
      "default": "Welcome to ORÉA. How can we assist you today? Whether you're looking for guidance on a piece, sizing help, or have questions about our bespoke services, we're here to help."
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "label": "Input Placeholder",
      "default": "Share your thoughts with us..."
    },
    {
      "type": "text",
      "id": "input_note",
      "label": "Input Note",
      "default": "Bespoke AI Guidance"
    }
  ]
}
{% endschema %}
